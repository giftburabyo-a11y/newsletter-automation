name: Newsletter Automation CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Install Chrome and ChromeDriver (chrome-for-testing)
        run: |
          STABLE_VERSION=$(curl -s https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions.json \
            | python3 -c "import sys,json; print(json.load(sys.stdin)['channels']['Stable']['version'])")
          echo "Installing Chrome for Testing: $STABLE_VERSION"

          BASE_URL="https://storage.googleapis.com/chrome-for-testing-public/${STABLE_VERSION}/linux64"

          wget -q "${BASE_URL}/chrome-linux64.zip" -O chrome.zip
          wget -q "${BASE_URL}/chromedriver-linux64.zip" -O chromedriver.zip

          unzip -q chrome.zip
          unzip -q chromedriver.zip

          sudo mv chrome-linux64/chrome /usr/local/bin/google-chrome-cft
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
          sudo chmod +x /usr/local/bin/google-chrome-cft /usr/local/bin/chromedriver

          sudo cp -r chrome-linux64/* /usr/local/bin/ 2>/dev/null || true

          chromedriver --version
          /usr/local/bin/google-chrome-cft --version || true

      - name: Increase /dev/shm size for Chrome
        run: |
          sudo mount -o remount,size=2g /dev/shm
          df -h /dev/shm

      - name: Start Xvfb virtual display
        run: |
          sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 &
          echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: Run Tests
        id: run-tests
        env:
          DISPLAY: :99
        run: |
          mvn test \
            -Dheadless=true \
            -Dwebdriver.chrome.driver=/usr/local/bin/chromedriver \
            -Dwebdriver.chrome.binary=/usr/local/bin/google-chrome-cft \
            -Djunit.jupiter.execution.parallel.enabled=false || true

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports/
          retention-days: 7

      - name: Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: |
            test-output/
            screenshots/
          retention-days: 7

      # âš ï¸ PARSE MUST COME BEFORE EMAIL AND SLACK
      - name: Parse Test Results
        if: always()
        id: test-results
        run: |
          TESTS=$(grep -h 'tests="' target/surefire-reports/*.xml | grep -oP 'tests="\K[0-9]+' | awk '{s+=$1} END {print s}')
          FAILURES=$(grep -h 'failures="' target/surefire-reports/*.xml | grep -oP 'failures="\K[0-9]+' | awk '{s+=$1} END {print s}')
          ERRORS=$(grep -h 'errors="' target/surefire-reports/*.xml | grep -oP 'errors="\K[0-9]+' | awk '{s+=$1} END {print s}')
          SKIPPED=$(grep -h 'skipped="' target/surefire-reports/*.xml | grep -oP 'skipped="\K[0-9]+' | awk '{s+=$1} END {print s}')
          PASSED=$((TESTS - FAILURES - ERRORS - SKIPPED))

          echo "total=$TESTS" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILURES" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT

          PASS_LIST=$(python3 -c "
          import xml.etree.ElementTree as ET, glob
          results = []
          for f in sorted(glob.glob('target/surefire-reports/*.xml')):
              tree = ET.parse(f)
              for tc in tree.findall('testcase'):
                  if tc.find('failure') is None and tc.find('error') is None:
                      results.append('âœ… ' + tc.get('name'))
          print('\n'.join(results))
          " | tr '\n' '|' | sed 's/|/\\n/g' | sed 's/\\n$//')

          FAIL_LIST=$(python3 -c "
          import xml.etree.ElementTree as ET, glob
          results = []
          for f in sorted(glob.glob('target/surefire-reports/*.xml')):
              tree = ET.parse(f)
              for tc in tree.findall('testcase'):
                  if tc.find('failure') is not None or tc.find('error') is not None:
                      results.append('âŒ ' + tc.get('name'))
          print('\n'.join(results))
          " | tr '\n' '|' | sed 's/|/\\n/g' | sed 's/\\n$//')

          echo "pass_list=$PASS_LIST" >> $GITHUB_OUTPUT
          echo "fail_list=$FAIL_LIST" >> $GITHUB_OUTPUT

      # Dynamically generates bug report cards from actual XML failure messages
      - name: Generate Failure Explanation Report
        if: always()
        run: |
          python3 - << 'PYEOF'
          import xml.etree.ElementTree as ET
          import glob
          import os

          md_lines = []
          md_lines.append('# Newsletter Automation â€” Test Failure Report\n')

          any_failures = False

          for f in sorted(glob.glob('target/surefire-reports/*.xml')):
              tree = ET.parse(f)
              root = tree.getroot()
              for tc in root.findall('testcase'):
                  name      = tc.get('name', 'Unknown')
                  classname = tc.get('classname', '')
                  failure   = tc.find('failure')
                  error     = tc.find('error')

                  if failure is not None or error is not None:
                      any_failures = True
                      node         = failure if failure is not None else error
                      fail_type    = node.get('type', 'Unknown')
                      fail_message = node.get('message', 'No message provided')
                      fail_text    = (node.text or '').strip()
                      stacktrace   = '\n'.join(fail_text.split('\n')[:5])

                      md_lines.append('---')
                      md_lines.append('## Bug Report: ' + name)
                      md_lines.append('**Class:** `' + classname + '`')
                      md_lines.append('**Failure Type:** `' + fail_type + '`')
                      md_lines.append('')
                      md_lines.append('**Description:**')
                      md_lines.append('The test `' + name + '` failed during the automated run. The application behaviour does not match the expected outcome defined in the test.')
                      md_lines.append('')
                      md_lines.append('**Failure Message:**')
                      md_lines.append('```')
                      md_lines.append(fail_message)
                      md_lines.append('```')
                      md_lines.append('')
                      md_lines.append('**Stacktrace (first 5 lines):**')
                      md_lines.append('```')
                      md_lines.append(stacktrace)
                      md_lines.append('```')
                      md_lines.append('')
                      md_lines.append('**Steps to Reproduce:**')
                      md_lines.append('1. Run test `' + name + '` against the Newsletter Signup form')
                      md_lines.append('2. Observe the failure at the assertion described above')
                      md_lines.append('')
                      md_lines.append('**Expected Result:** Test assertion passes and application behaves as specified')
                      md_lines.append('')
                      md_lines.append('**Actual Result:** ' + fail_message)
                      md_lines.append('')
                      md_lines.append('**Environment:**')
                      md_lines.append('- Application: Newsletter Sign-up Form')
                      md_lines.append('- Platform: Web (Headless Chrome on Ubuntu)')
                      md_lines.append('- CI: GitHub Actions')
                      md_lines.append('')

          if not any_failures:
              md_lines.append('## All tests passed! No failures to report.')

          with open('failure-report.md', 'w') as fh:
              fh.write('\n'.join(md_lines))

          print('Failure report generated')
          PYEOF

      - name: Upload Failure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: failure-explanation-report
          path: failure-report.md
          retention-days: 7

      - name: Send Email Report
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.GMAIL_ADRESS }}
          password: ${{ secrets.GMAIL_APP_PASS }}
          to: ${{ secrets.REPORT_EMAIL }}
          from: Newsletter CI <${{ secrets.GMAIL_ADRESS }}>
          subject: "ğŸ“‹ Newsletter Selenium Tests â€” Run #${{ github.run_number }} Complete"
          html_body: |
            <html>
            <body style="font-family: Arial, sans-serif; max-width: 700px; margin: auto; padding: 20px; background: #f9f9f9;">
              <div style="background: #2c3e50; color: white; padding: 20px; border-radius: 8px 8px 0 0;">
                <h1 style="margin:0; font-size: 22px;">ğŸ“‹ Newsletter Selenium Tests â€” Run Complete</h1>
              </div>
              <div style="background: white; padding: 20px; border: 1px solid #ddd;">

                <h3 style="border-bottom: 2px solid #eee; padding-bottom: 8px;">ğŸ“‹ Run Details</h3>
                <table style="width:100%; border-collapse: collapse;">
                  <tr>
                    <td style="padding: 8px; color: #666; width: 40%;"><strong>ğŸ“ Repository</strong></td>
                    <td style="padding: 8px;">${{ github.repository }}</td>
                  </tr>
                  <tr style="background:#f9f9f9;">
                    <td style="padding: 8px; color: #666;"><strong>ğŸŒ¿ Branch</strong></td>
                    <td style="padding: 8px;">${{ github.ref_name }}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; color: #666;"><strong>ğŸ‘¤ Triggered by</strong></td>
                    <td style="padding: 8px;">${{ github.actor }}</td>
                  </tr>
                  <tr style="background:#f9f9f9;">
                    <td style="padding: 8px; color: #666;"><strong>ğŸ”— Run</strong></td>
                    <td style="padding: 8px;">
                      <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" style="color: #2c3e50;">
                        View Run #${{ github.run_number }}
                      </a>
                    </td>
                  </tr>
                </table>

                <h3 style="border-bottom: 2px solid #eee; padding-bottom: 8px; margin-top: 24px;">ğŸ“Š Test Summary</h3>
                <table style="width:100%; border-collapse: collapse; text-align: center;">
                  <tr style="background: #f0f0f0;">
                    <th style="padding: 10px; border: 1px solid #ddd;">ğŸ“‹ Total</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">âœ… Passed</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">âŒ Failed</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">â­ï¸ Skipped</th>
                  </tr>
                  <tr>
                    <td style="padding: 10px; border: 1px solid #ddd; font-size: 20px; font-weight: bold;">${{ steps.test-results.outputs.total }}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; font-size: 20px; font-weight: bold; color: #36a64f;">${{ steps.test-results.outputs.passed }}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; font-size: 20px; font-weight: bold; color: #e01e5a;">${{ steps.test-results.outputs.failed }}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; font-size: 20px; font-weight: bold; color: #888;">${{ steps.test-results.outputs.skipped }}</td>
                  </tr>
                </table>

                <h3 style="border-bottom: 2px solid #eee; padding-bottom: 8px; margin-top: 24px;">âœ… Passed Tests</h3>
                <p style="background: #f6ffed; border-left: 4px solid #36a64f; padding: 12px; white-space: pre-line; font-family: monospace;">${{ steps.test-results.outputs.pass_list }}</p>

                <h3 style="border-bottom: 2px solid #eee; padding-bottom: 8px; margin-top: 24px;">ğŸ› Failed Test Bug Reports</h3>
                <p style="color: #666; font-size: 13px;">Full bug reports for each failure are available in the <strong>failure-explanation-report</strong> artifact attached to this run.</p>
                <p style="background: #fff0f3; border-left: 4px solid #e01e5a; padding: 12px; white-space: pre-line; font-family: monospace;">${{ steps.test-results.outputs.fail_list }}</p>
                <p style="color: #666; font-size: 13px; margin-top: 12px;">These are application defects detected by the automated test suite. The pipeline is configured to continue regardless so passing tests are not blocked.</p>

              </div>
              <div style="background: #f0f0f0; padding: 12px; border-radius: 0 0 8px 8px; text-align: center; color: #888; font-size: 12px;">
                ğŸ•’ ${{ github.event.head_commit.timestamp }} â€¢ Newsletter Automation CI
              </div>
            </body>
            </html>

      - name: Notify Slack on completion
        if: always()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸ“‹ Newsletter Selenium Tests â€” Run Complete"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*ğŸ“ Repository*\n${{ github.repository }}" },
                    { "type": "mrkdwn", "text": "*ğŸŒ¿ Branch*\n${{ github.ref_name }}" },
                    { "type": "mrkdwn", "text": "*ğŸ‘¤ Triggered by*\n${{ github.actor }}" },
                    { "type": "mrkdwn", "text": "*ğŸ”— Run*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run #${{ github.run_number }}>" }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": { "type": "mrkdwn", "text": "*ğŸ“Š Test Summary*" }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*ğŸ“‹ Total*\n${{ steps.test-results.outputs.total }}" },
                    { "type": "mrkdwn", "text": "*âœ… Passed*\n${{ steps.test-results.outputs.passed }}" },
                    { "type": "mrkdwn", "text": "*âŒ Failed*\n${{ steps.test-results.outputs.failed }}" },
                    { "type": "mrkdwn", "text": "*â­ï¸ Skipped*\n${{ steps.test-results.outputs.skipped }}" }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*âœ… Passed Tests*\n${{ steps.test-results.outputs.pass_list }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*âŒ Failed Tests*\n${{ steps.test-results.outputs.fail_list }}"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ğŸ› Full bug reports for each failure are in the failure-explanation-report artifact attached to this Actions run.*"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "ğŸ•’ ${{ github.event.head_commit.timestamp }} â€¢ Application defects detected â€” pipeline passes regardless"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK