name: Newsletter Automation CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
jobs:
  test:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Install Chrome and ChromeDriver (chrome-for-testing)
        run: |
          STABLE_VERSION=$(curl -s https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions.json \
            | python3 -c "import sys,json; print(json.load(sys.stdin)['channels']['Stable']['version'])")
          echo "Installing Chrome for Testing: $STABLE_VERSION"

          BASE_URL="https://storage.googleapis.com/chrome-for-testing-public/${STABLE_VERSION}/linux64"

          wget -q "${BASE_URL}/chrome-linux64.zip" -O chrome.zip
          wget -q "${BASE_URL}/chromedriver-linux64.zip" -O chromedriver.zip

          unzip -q chrome.zip
          unzip -q chromedriver.zip

          sudo mv chrome-linux64/chrome /usr/local/bin/google-chrome-cft
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
          sudo chmod +x /usr/local/bin/google-chrome-cft /usr/local/bin/chromedriver

          sudo cp -r chrome-linux64/* /usr/local/bin/ 2>/dev/null || true

          chromedriver --version
          /usr/local/bin/google-chrome-cft --version || true

      - name: Increase /dev/shm size for Chrome
        run: |
          sudo mount -o remount,size=2g /dev/shm
          df -h /dev/shm

      - name: Start Xvfb virtual display
        run: |
          sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 &
          echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: Run Tests
        id: run-tests
        env:
          DISPLAY: :99
        run: |
          mvn test \
            -Dheadless=true \
            -Dwebdriver.chrome.driver=/usr/local/bin/chromedriver \
            -Dwebdriver.chrome.binary=/usr/local/bin/google-chrome-cft \
            -Djunit.jupiter.execution.parallel.enabled=false

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports/
          retention-days: 7

      - name: Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: |
            test-output/
            screenshots/
          retention-days: 7

      - name: Parse Test Results
        if: always()
        id: test-results
        run: |
          TESTS=$(grep -h 'tests="' target/surefire-reports/*.xml | grep -oP 'tests="\K[0-9]+' | awk '{s+=$1} END {print s}')
          FAILURES=$(grep -h 'failures="' target/surefire-reports/*.xml | grep -oP 'failures="\K[0-9]+' | awk '{s+=$1} END {print s}')
          ERRORS=$(grep -h 'errors="' target/surefire-reports/*.xml | grep -oP 'errors="\K[0-9]+' | awk '{s+=$1} END {print s}')
          SKIPPED=$(grep -h 'skipped="' target/surefire-reports/*.xml | grep -oP 'skipped="\K[0-9]+' | awk '{s+=$1} END {print s}')
          PASSED=$((TESTS - FAILURES - ERRORS - SKIPPED))

          echo "total=$TESTS" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILURES" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT

          PASS_LIST=$(python3 -c "
          import xml.etree.ElementTree as ET, glob
          results = []
          for f in sorted(glob.glob('target/surefire-reports/*.xml')):
              tree = ET.parse(f)
              for tc in tree.findall('testcase'):
                  if tc.find('failure') is None and tc.find('error') is None:
                      results.append('âœ… ' + tc.get('name'))
          print('\n'.join(results))
          " | tr '\n' '|' | sed 's/|/\\n/g' | sed 's/\\n$//')

          FAIL_LIST=$(python3 -c "
          import xml.etree.ElementTree as ET, glob
          results = []
          for f in sorted(glob.glob('target/surefire-reports/*.xml')):
              tree = ET.parse(f)
              for tc in tree.findall('testcase'):
                  if tc.find('failure') is not None or tc.find('error') is not None:
                      results.append('âŒ ' + tc.get('name'))
          print('\n'.join(results))
          " | tr '\n' '|' | sed 's/|/\\n/g' | sed 's/\\n$//')

          echo "pass_list=$PASS_LIST" >> $GITHUB_OUTPUT
          echo "fail_list=$FAIL_LIST" >> $GITHUB_OUTPUT

      - name: Send Email on success
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.GMAIL_ADRESS }}
          password: ${{ secrets.GMAIL_APP_PASS }}
          to: ${{ secrets.REPORT_EMAIL }}
          from: Newsletter CI <${{ secrets.GMAIL_ADRESS }}>
          subject: "âœ… Newsletter Selenium Tests â€” PASSED | Run #${{ github.run_number }}"
          html_body: |
            <html>
            <body style="font-family: Arial, sans-serif; max-width: 700px; margin: auto; padding: 20px; background: #f9f9f9;">
              <div style="background: #36a64f; color: white; padding: 20px; border-radius: 8px 8px 0 0;">
                <h1 style="margin:0; font-size: 22px;">âœ… Newsletter Selenium Tests â€” PASSED</h1>
              </div>
              <div style="background: white; padding: 20px; border: 1px solid #ddd;">

                <h3 style="border-bottom: 2px solid #eee; padding-bottom: 8px;">ğŸ“‹ Run Details</h3>
                <table style="width:100%; border-collapse: collapse;">
                  <tr>
                    <td style="padding: 8px; color: #666; width: 40%;"><strong>ğŸ“ Repository</strong></td>
                    <td style="padding: 8px;">${{ github.repository }}</td>
                  </tr>
                  <tr style="background:#f9f9f9;">
                    <td style="padding: 8px; color: #666;"><strong>ğŸŒ¿ Branch</strong></td>
                    <td style="padding: 8px;">${{ github.ref_name }}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; color: #666;"><strong>ğŸ‘¤ Triggered by</strong></td>
                    <td style="padding: 8px;">${{ github.actor }}</td>
                  </tr>
                  <tr style="background:#f9f9f9;">
                    <td style="padding: 8px; color: #666;"><strong>ğŸ”— Run</strong></td>
                    <td style="padding: 8px;">
                      <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" style="color: #36a64f;">
                        View Run #${{ github.run_number }}
                      </a>
                    </td>
                  </tr>
                </table>

                <h3 style="border-bottom: 2px solid #eee; padding-bottom: 8px; margin-top: 24px;">ğŸ“Š Test Summary</h3>
                <table style="width:100%; border-collapse: collapse; text-align: center;">
                  <tr style="background: #f0f0f0;">
                    <th style="padding: 10px; border: 1px solid #ddd;">ğŸ“‹ Total</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">âœ… Passed</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">âŒ Failed</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">â­ï¸ Skipped</th>
                  </tr>
                  <tr>
                    <td style="padding: 10px; border: 1px solid #ddd; font-size: 20px; font-weight: bold;">${{ steps.test-results.outputs.total }}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; font-size: 20px; font-weight: bold; color: #36a64f;">${{ steps.test-results.outputs.passed }}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; font-size: 20px; font-weight: bold; color: #e01e5a;">${{ steps.test-results.outputs.failed }}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; font-size: 20px; font-weight: bold; color: #888;">${{ steps.test-results.outputs.skipped }}</td>
                  </tr>
                </table>

                <h3 style="border-bottom: 2px solid #eee; padding-bottom: 8px; margin-top: 24px;">âœ… Passed Tests</h3>
                <p style="background: #f6ffed; border-left: 4px solid #36a64f; padding: 12px; white-space: pre-line; font-family: monospace;">${{ steps.test-results.outputs.pass_list }}</p>

              </div>
              <div style="background: #f0f0f0; padding: 12px; border-radius: 0 0 8px 8px; text-align: center; color: #888; font-size: 12px;">
                ğŸ•’ ${{ github.event.head_commit.timestamp }} â€¢ Newsletter Automation CI
              </div>
            </body>
            </html>

      - name: Send Email on failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.GMAIL_ADRESS }}
          password: ${{ secrets.GMAIL_APP_PASS }}
          to: ${{ secrets.REPORT_EMAIL }}
          from: Newsletter CI <${{ secrets.GMAIL_ADRESS }}>
          subject: "âŒ Newsletter Selenium Tests â€” FAILED | Run #${{ github.run_number }}"
          html_body: |
            <html>
            <body style="font-family: Arial, sans-serif; max-width: 700px; margin: auto; padding: 20px; background: #f9f9f9;">
              <div style="background: #e01e5a; color: white; padding: 20px; border-radius: 8px 8px 0 0;">
                <h1 style="margin:0; font-size: 22px;">âŒ Newsletter Selenium Tests â€” FAILED</h1>
              </div>
              <div style="background: white; padding: 20px; border: 1px solid #ddd;">

                <h3 style="border-bottom: 2px solid #eee; padding-bottom: 8px;">ğŸ“‹ Run Details</h3>
                <table style="width:100%; border-collapse: collapse;">
                  <tr>
                    <td style="padding: 8px; color: #666; width: 40%;"><strong>ğŸ“ Repository</strong></td>
                    <td style="padding: 8px;">${{ github.repository }}</td>
                  </tr>
                  <tr style="background:#f9f9f9;">
                    <td style="padding: 8px; color: #666;"><strong>ğŸŒ¿ Branch</strong></td>
                    <td style="padding: 8px;">${{ github.ref_name }}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; color: #666;"><strong>ğŸ‘¤ Triggered by</strong></td>
                    <td style="padding: 8px;">${{ github.actor }}</td>
                  </tr>
                  <tr style="background:#f9f9f9;">
                    <td style="padding: 8px; color: #666;"><strong>ğŸ”— Run</strong></td>
                    <td style="padding: 8px;">
                      <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" style="color: #e01e5a;">
                        View Run #${{ github.run_number }}
                      </a>
                    </td>
                  </tr>
                </table>

                <h3 style="border-bottom: 2px solid #eee; padding-bottom: 8px; margin-top: 24px;">ğŸ“Š Test Summary</h3>
                <table style="width:100%; border-collapse: collapse; text-align: center;">
                  <tr style="background: #f0f0f0;">
                    <th style="padding: 10px; border: 1px solid #ddd;">ğŸ“‹ Total</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">âœ… Passed</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">âŒ Failed</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">â­ï¸ Skipped</th>
                  </tr>
                  <tr>
                    <td style="padding: 10px; border: 1px solid #ddd; font-size: 20px; font-weight: bold;">${{ steps.test-results.outputs.total }}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; font-size: 20px; font-weight: bold; color: #36a64f;">${{ steps.test-results.outputs.passed }}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; font-size: 20px; font-weight: bold; color: #e01e5a;">${{ steps.test-results.outputs.failed }}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; font-size: 20px; font-weight: bold; color: #888;">${{ steps.test-results.outputs.skipped }}</td>
                  </tr>
                </table>

                <h3 style="border-bottom: 2px solid #eee; padding-bottom: 8px; margin-top: 24px;">âœ… Passed Tests</h3>
                <p style="background: #f6ffed; border-left: 4px solid #36a64f; padding: 12px; white-space: pre-line; font-family: monospace;">${{ steps.test-results.outputs.pass_list }}</p>

                <h3 style="border-bottom: 2px solid #eee; padding-bottom: 8px; margin-top: 24px;">âŒ Failed Tests</h3>
                <p style="background: #fff0f3; border-left: 4px solid #e01e5a; padding: 12px; white-space: pre-line; font-family: monospace;">${{ steps.test-results.outputs.fail_list }}</p>

              </div>
              <div style="background: #f0f0f0; padding: 12px; border-radius: 0 0 8px 8px; text-align: center; color: #888; font-size: 12px;">
                ğŸ•’ ${{ github.event.head_commit.timestamp }} â€¢ Newsletter Automation CI
              </div>
            </body>
            </html>

      - name: Notify Slack on success
        if: success()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "âœ… Newsletter Selenium Tests â€” PASSED"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*ğŸ“ Repository*\n${{ github.repository }}" },
                    { "type": "mrkdwn", "text": "*ğŸŒ¿ Branch*\n${{ github.ref_name }}" },
                    { "type": "mrkdwn", "text": "*ğŸ‘¤ Triggered by*\n${{ github.actor }}" },
                    { "type": "mrkdwn", "text": "*ğŸ”— Run*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run #${{ github.run_number }}>" }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": { "type": "mrkdwn", "text": "*ğŸ“Š Test Summary*" }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*ğŸ“‹ Total*\n${{ steps.test-results.outputs.total }}" },
                    { "type": "mrkdwn", "text": "*âœ… Passed*\n${{ steps.test-results.outputs.passed }}" },
                    { "type": "mrkdwn", "text": "*âŒ Failed*\n${{ steps.test-results.outputs.failed }}" },
                    { "type": "mrkdwn", "text": "*â­ï¸ Skipped*\n${{ steps.test-results.outputs.skipped }}" }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*âœ… Passed Tests*\n${{ steps.test-results.outputs.pass_list }}"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "ğŸ•’ Completed at ${{ github.event.head_commit.timestamp }} â€¢ Newsletter Automation CI"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Notify Slack on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "âŒ Newsletter Selenium Tests â€” FAILED"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*ğŸ“ Repository*\n${{ github.repository }}" },
                    { "type": "mrkdwn", "text": "*ğŸŒ¿ Branch*\n${{ github.ref_name }}" },
                    { "type": "mrkdwn", "text": "*ğŸ‘¤ Triggered by*\n${{ github.actor }}" },
                    { "type": "mrkdwn", "text": "*ğŸ”— Run*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run #${{ github.run_number }}>" }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": { "type": "mrkdwn", "text": "*ğŸ“Š Test Summary*" }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*ğŸ“‹ Total*\n${{ steps.test-results.outputs.total }}" },
                    { "type": "mrkdwn", "text": "*âœ… Passed*\n${{ steps.test-results.outputs.passed }}" },
                    { "type": "mrkdwn", "text": "*âŒ Failed*\n${{ steps.test-results.outputs.failed }}" },
                    { "type": "mrkdwn", "text": "*â­ï¸ Skipped*\n${{ steps.test-results.outputs.skipped }}" }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*âœ… Passed Tests*\n${{ steps.test-results.outputs.pass_list }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*âŒ Failed Tests*\n${{ steps.test-results.outputs.fail_list }}"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "ğŸ•’ Completed at ${{ github.event.head_commit.timestamp }} â€¢ Newsletter Automation CI"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Fail build on test failures
        if: steps.run-tests.outcome == 'failure'
        run: exit 1