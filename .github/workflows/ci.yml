name: Newsletter Selenium Tests

# â”€â”€ Triggers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

# â”€â”€ Permissions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
permissions:
  contents: read
  checks: write
  pull-requests: write

# â”€â”€ Jobs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  selenium-tests:
    name: Run Selenium Tests (JUnit 5)
    runs-on: ubuntu-latest

    steps:

      # 1. Check out the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Java 21
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      # 3. Cache Maven dependencies
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      # 4. Run tests in headless mode with the 'ci' Maven profile
      - name: Run Selenium tests (headless)
        id: run-tests
        run: |
          mvn test -P ci \
            -Dheadless=true \
            -Dbase.url=https://bayingana.github.io/NEWSLETTER/ \
            -Dmaven.test.failure.ignore=true \
            --batch-mode \
            --no-transfer-progress
        env:
          DISPLAY: :99

      # 5. Parse surefire XML and expose counts + failure details
      - name: Parse test results
        if: always()
        id: parse-results
        run: |
          TOTAL=0; PASSED=0; FAILED=0; SKIPPED=0; ERRORS=0
          for f in target/surefire-reports/TEST-*.xml; do
            [ -f "$f" ] || continue
            t=$(grep  -oP 'tests="\K[0-9]+'    "$f" | head -1)
            fa=$(grep -oP 'failures="\K[0-9]+' "$f" | head -1)
            sk=$(grep -oP 'skipped="\K[0-9]+'  "$f" | head -1)
            er=$(grep -oP 'errors="\K[0-9]+'   "$f" | head -1)
            TOTAL=$((TOTAL   + ${t:-0}))
            FAILED=$((FAILED  + ${fa:-0}))
            SKIPPED=$((SKIPPED + ${sk:-0}))
            ERRORS=$((ERRORS  + ${er:-0}))
          done
          PASSED=$((TOTAL - FAILED - SKIPPED - ERRORS))
          [ "$TOTAL" -gt 0 ] && PASS_PCT=$((PASSED * 100 / TOTAL)) || PASS_PCT=0
          # Build HTML rows for failed tests
          FAILURES_HTML=""
          for f in target/surefire-reports/TEST-*.xml; do
            [ -f "$f" ] || continue
            while IFS='|' read -r cls nm msg; do
              FAILURES_HTML+="<tr>"
              FAILURES_HTML+="<td style='padding:8px 12px;border-bottom:1px solid #eee;font-family:monospace;font-size:12px;color:#b71c1c'>${cls}</td>"
              FAILURES_HTML+="<td style='padding:8px 12px;border-bottom:1px solid #eee;font-size:13px'>${nm}</td>"
              FAILURES_HTML+="<td style='padding:8px 12px;border-bottom:1px solid #eee;font-size:12px;color:#555'>${msg}</td>"
              FAILURES_HTML+="</tr>"
            done < <(python3 - "$f" <<'PYEOF'
          import sys, xml.etree.ElementTree as ET
          tree = ET.parse(sys.argv[1])
          for tc in tree.findall('.//testcase'):
              node = tc.find('failure') or tc.find('error')
              if node is None: continue
              msg = ((node.get('message') or node.text or '').strip())[:280]
              print(f"{tc.get('classname','')}|{tc.get('name','')}|{msg}")
          PYEOF
            )
          done
          echo "total=$TOTAL"     >> $GITHUB_OUTPUT
          echo "passed=$PASSED"   >> $GITHUB_OUTPUT
          echo "failed=$FAILED"   >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS"   >> $GITHUB_OUTPUT
          echo "pass_pct=$PASS_PCT" >> $GITHUB_OUTPUT
          {
            echo "failures_html<<HTMLEOF"
            printf '%s' "$FAILURES_HTML"
            echo ""
            echo "HTMLEOF"
          } >> $GITHUB_OUTPUT
      # 6. Publish JUnit 5 test results as GitHub Check
      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: target/surefire-reports/**/*.xml
          check_name: "Selenium Test Results"
          comment_on_pr: true
          fail_on: "test failures"

      # 7. Generate Allure Report
      - name: Generate Allure Report
        run: mvn allure:report
        if: always()

      # 8. Upload Allure Report as artifact
      - name: Upload Allure Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-report
          path: target/site/allure-maven-plugin/

      # 9. Upload Surefire reports as downloadable artifact
      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: surefire-reports-${{ github.run_number }}
          path: target/surefire-reports/
          retention-days: 14

      # 9b. Extract rich failure details from Allure JSON
      - name: Extract rich failure details
        if: always()
        id: extract-failures
        run: |
          python3 << 'PYEOF'
          import json, os, sys, re
          from glob import glob
          failing_tests = []
          for json_file in sorted(glob("target/allure-results/*-result.json")):
              try:
                  with open(json_file, 'r', encoding='utf-8') as f:
                      data = json.load(f)
              except: continue
              if data.get("status") in ["failed", "broken"]:
                  labels = {l["name"]: l["value"] for l in data.get("labels", [])}
                  test_class = labels.get("testClass", "").split(".")[-1] or "Unknown"
          
                  steps_list = []
                  for i, s in enumerate(data.get("steps", []), 1):
                      steps_list.append(f"{i}. {s.get('name', 'Step')}")
                  steps_str = "\n".join(steps_list) if steps_list else "See full report for trace."
                  desc = data.get("description", "No description provided.")
                  impact = "High: Defect needs immediate investigation."
                  if "**Impact:**" in desc:
                      parts = desc.split("**Impact:**")
                      desc, impact = parts[0].strip(), parts[1].strip()
                  severity = labels.get("severity", "normal").capitalize()
                  priority = "High" if severity in ["Blocker", "Critical"] else ("Medium" if severity == "Normal" else "Low")
                  has_ss = any("screenshot" in att.get("name", "").lower() for att in data.get("attachments", []))
                  failing_tests.append({
                      "name": data.get("name", "Unknown"),
                      "class": test_class,
                      "desc": desc,
                      "steps": steps_str,
                      "expected": data.get("statusDetails", {}).get("message", "N/A"),
                      "impact": impact,
                      "priority": f"{priority} ({severity})",
                      "screenshot": "ðŸ“¸ Captured" if has_ss else "âŒ None"
                  })
          with open("rich_failures.json", "w") as f:
              json.dump(failing_tests, f)
          PYEOF
      - name: Send email report
        if: always()
        env:
          GMAIL_ADDRESS:  ${{ secrets.GMAIL_ADRESS }}
          GMAIL_APP_PASS: ${{ secrets.GMAIL_APP_PASS }}
          REPORT_TO:      ${{ secrets.REPORT_EMAIL }}
        run: |
          python3 << 'PYEOF'
          import os, smtplib, json
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          from datetime import datetime, timezone
          gmail_user = os.environ["GMAIL_ADDRESS"]
          gmail_pass = os.environ["GMAIL_APP_PASS"]
          report_to  = os.environ["REPORT_TO"]
          total    = "${{ steps.parse-results.outputs.total }}"    or "0"
          passed   = "${{ steps.parse-results.outputs.passed }}"   or "0"
          failed   = "${{ steps.parse-results.outputs.failed }}"   or "0"
          skipped  = "${{ steps.parse-results.outputs.skipped }}"  or "0"
          pass_pct = "${{ steps.parse-results.outputs.pass_pct }}" or "0"
          
          # Load rich failures
          try:
              with open("rich_failures.json", "r") as f:
                  rich_failures = json.load(f)
          except: rich_failures = []
          outcome = "${{ steps.run-tests.outcome }}"
          is_pass = (outcome == "success" and int(failed) == 0)
          status    = "PASSED"  if is_pass else "FAILED"
          s_icon    = "âœ…"       if is_pass else "âŒ"
          s_color   = "#2e7d32" if is_pass else "#e01e5a"
          s_bg      = "#e8f5e9" if is_pass else "#fff5f7"
          run_url    = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          artifacts_url = f"{run_url}#artifacts"
          timestamp  = datetime.now(timezone.utc).strftime("%d %B %Y at %H:%M UTC")
          # Build detailed failure blocks for Email
          fail_block = ""
          if rich_failures:
              fail_block = f'<h2 style="margin:32px 0 12px;font-size:18px;color:#e01e5a">ðŸš¨ {len(rich_failures)} Failing Test Case(s) â€” Detailed Report</h2>'
              for i, t in enumerate(rich_failures, 1):
                  fail_block += f"""
                  <div style="border:1px solid #ffccd5; border-radius:8px; margin-bottom:20px; background:#fffcfc; overflow:hidden">
                    <div style="background:#fff0f3; padding:12px 16px; border-bottom:1px solid #ffccd5">
                      <strong style="color:#c92a2a; font-size:15px">Test case {i}: {t['name']}</strong><br>
                      <small style="color:#666">Class: {t['class']}</small>
                    </div>
                    <div style="padding:16px; font-size:13px; line-height:1.6; color:#333">
                      <p style="margin:0 0 10px"><strong>Description:</strong><br>{t['desc']}</p>
                      <p style="margin:0 0 10px"><strong>Steps to Reproduce:</strong><br><span style="white-space:pre-wrap">{t['steps']}</span></p>
                      <p style="margin:0 0 10px"><strong>Actual Result:</strong><br><code style="background:#f8f9fa; padding:4px 8px; display:block; border:1px solid #dee2e6">{t['expected']}</code></p>
                      <p style="margin:0 0 10px"><strong>Impact:</strong><br>{t['impact']}</p>
                      <div style="display:flex; gap:20px; margin-top:15px; border-top:1px solid #eee; padding-top:10px">
                        <span><strong>Priority:</strong> {t['priority']}</span>&nbsp;&nbsp;&nbsp;
                        <span><strong>Screenshot:</strong> {t['screenshot']}</span>
                      </div>
                    </div>
                  </div>"""
          html = f"""<!DOCTYPE html><html><body style="margin:0;padding:20px;background:#f4f6f9;font-family:Arial,sans-serif">
          <table width="640" align="center" style="background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.1)">
            <tr><td style="background:#1a237e;padding:30px;color:#fff">
              <h1 style="margin:0;font-size:24px">Newsletter CI Report</h1>
              <p style="margin:5px 0 0;opacity:0.8">Run #{run_num} &middot; {status}</p>
            </td></tr>
            <tr><td style="padding:20px 30px;background:{s_bg};border-left:5px solid {s_color}">
              <p style="margin:0;font-size:18px;font-weight:700;color:{s_color}">{s_icon} Test Suite {status}</p>
              <p style="margin:5px 0 0;font-size:12px;color:#666">Completed {timestamp}</p>
            </td></tr>
            <tr><td style="padding:30px">
              <table width="100%" style="margin-bottom:20px">
                <tr>
                  <td align="center" style="background:#e8f5e9;padding:15px;border-radius:6px"><div style="color:#2e7d32;font-size:20px;font-weight:700">{passed}</div><div style="font-size:11px;color:#666">PASSED</div></td>
                  <td width="10"></td>
                  <td align="center" style="background:#fff5f7;padding:15px;border-radius:6px"><div style="color:#e01e5a;font-size:20px;font-weight:700">{failed}</div><div style="font-size:11px;color:#666">FAILED</div></td>
                  <td width="10"></td>
                  <td align="center" style="background:#f5f5f5;padding:15px;border-radius:6px"><div style="color:#666;font-size:20px;font-weight:700">{total}</div><div style="font-size:11px;color:#666">TOTAL</div></td>
                </tr>
              </table>
              {fail_block}
              <div style="text-align:center;margin-top:30px">
                <a href="{run_url}" style="background:#1a237e;color:#fff;padding:12px 25px;text-decoration:none;border-radius:5px;font-weight:700">View Run on GitHub</a>
                <br><br>
                <a href="{artifacts_url}" style="color:#1a237e;font-size:13px">Download Allure Report Artifact &rarr;</a>
              </div>
            </td></tr>
          </table></body></html>"""
          msg = MIMEMultipart("alternative")
          msg["Subject"] = f"{s_icon} [Run #{run_num}] Newsletter Tests {status}"
          msg["From"] = f"Newsletter CI <{gmail_user}>"
          msg["To"] = report_to
          msg.attach(MIMEText(html, "html"))
          with smtplib.SMTP_SSL("smtp.gmail.com", 465) as server:
              server.login(gmail_user, gmail_pass)
              server.sendmail(gmail_user, report_to, msg.as_string())
          PYEOF
      - name: Send Slack report
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          python3 << 'PYEOF'
          import json, os, subprocess, sys
          webhook = os.environ.get("SLACK_WEBHOOK_URL", "")
          if not webhook:
              print("No SLACK_WEBHOOK_URL set â€” skipping")
              sys.exit(0)
          # High-level values
          total    = "${{ steps.parse-results.outputs.total }}"    or "0"
          passed   = "${{ steps.parse-results.outputs.passed }}"   or "0"
          failed   = "${{ steps.parse-results.outputs.failed }}"   or "0"
          skipped  = "${{ steps.parse-results.outputs.skipped }}"  or "0"
          pass_pct = "${{ steps.parse-results.outputs.pass_pct }}" or "0"
          
          # Load rich failures from common file
          try:
              with open("rich_failures.json", "r") as f:
                  failing_tests = json.load(f)
          except:
              failing_tests = []
          repo     = "${{ github.repository }}"
          branch   = "${{ github.ref_name }}"
          actor    = "${{ github.actor }}"
          run_num  = "${{ github.run_number }}"
          run_url  = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          artifacts_url = f"{run_url}#artifacts"
          sha      = "${{ github.sha }}"[:7]
          commit_msg = "${{ github.event.head_commit.message }}"
          event = "${{ github.event_name }}"
          trigger = {
              "push":               "Push to branch",
              "pull_request":       "Pull Request #${{ github.event.pull_request.number }}",
              "workflow_dispatch":  "Manual trigger",
          }.get(event, event)
          outcome  = "${{ steps.run-tests.outcome }}"
          is_pass  = (outcome == "success" and int(failed) == 0)
          header_color = "#2e7d32" if is_pass else "#e01e5a"
          status_emoji = "âœ…" if is_pass else "âŒ"
          status_label = "PASSED" if is_pass else "FAILED"
          failure_blocks = []
          for i, t in enumerate(failing_tests, 1):
              block_text = (
                  f"*Test Case {i}:* `{t['name']}`\n"
                  f"*Class:* `{t['class']}`\n\n"
                  f"*Description*\n{t['desc']}\n\n"
                  f"*Steps to Reproduce*\n{t['steps']}\n\n"
                  f"*Actual Result (Assertion)*\n```\n{t['expected'][:300]}\n```\n"
                  f"*Impact*\n{t['impact']}\n\n"
                  f"*Priority:* {t['priority']}\n"
                  f"*Screenshot:* {t['screenshot']}"
              )
              failure_blocks.append({"type": "section", "text": {"type": "mrkdwn", "text": block_text}})
              if i < len(failing_tests):
                  failure_blocks.append({"type": "divider"})
          header_block = {
              "type": "header",
              "text": {"type": "plain_text", "text": f"{status_emoji} Newsletter CI â€” {status_label}", "emoji": True}
          }
          summary_block = {
              "type": "section",
              "fields": [
                  {"type": "mrkdwn", "text": f"*Repo*\n{repo}"},
                  {"type": "mrkdwn", "text": f"*Branch*\n{branch}"},
                  {"type": "mrkdwn", "text": f"*Commit*\n`{sha}`"},
                  {"type": "mrkdwn", "text": f"*Trigger*\n{actor} ({trigger})"},
              ]
          }
          stats_block = {
              "type": "section",
              "text": {
                  "type": "mrkdwn",
                  "text": f"*Test Summary*\nâœ… *{passed}* Passed  |  âŒ *{failed}* Failed  |  â­ *{skipped}* Skipped  |  ðŸ“ˆ *{pass_pct}%*"
              }
          }
          blocks = [header_block, {"type": "divider"}, summary_block, stats_block]
          if failing_tests:
              blocks.append({"type": "divider"})
              blocks.append({"type": "section", "text": {"type": "mrkdwn", "text": f":rotating_light: *{len(failing_tests)} Detailed Failure Report(s)*"}})
              blocks.append({"type": "divider"})
              blocks.extend(failure_blocks)
          else:
              blocks.append({"type": "section", "text": {"type": "mrkdwn", "text": ":white_check_mark: All tests passed successfully."}})
          blocks.append({"type": "divider"})
          blocks.append({
              "type": "actions",
              "elements": [
                  {"type": "button", "text": {"type": "plain_text", "text": "View Action Run"}, "url": run_url, "style": "primary"},
                  {"type": "button", "text": {"type": "plain_text", "text": "Download Allure Report"}, "url": artifacts_url}
              ]
          })
          payload = {
              "text": f"{status_emoji} Newsletter Tests {status_label} â€” Run #{run_num}",
              "attachments": [{"color": header_color, "blocks": blocks}]
          }
          subprocess.run(["curl", "-s", "-X", "POST", webhook, "-H", "Content-Type: application/json", "-d", json.dumps(payload)])
          PYEOF
