name: Newsletter Automation CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Install Chrome and ChromeDriver (chrome-for-testing)
        run: |
          STABLE_VERSION=$(curl -s https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions.json \
            | python3 -c "import sys,json; print(json.load(sys.stdin)['channels']['Stable']['version'])")
          echo "Installing Chrome for Testing: $STABLE_VERSION"

          BASE_URL="https://storage.googleapis.com/chrome-for-testing-public/${STABLE_VERSION}/linux64"

          wget -q "${BASE_URL}/chrome-linux64.zip" -O chrome.zip
          wget -q "${BASE_URL}/chromedriver-linux64.zip" -O chromedriver.zip

          unzip -q chrome.zip
          unzip -q chromedriver.zip

          sudo mv chrome-linux64/chrome /usr/local/bin/google-chrome-cft
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
          sudo chmod +x /usr/local/bin/google-chrome-cft /usr/local/bin/chromedriver

          sudo cp -r chrome-linux64/* /usr/local/bin/ 2>/dev/null || true

          chromedriver --version
          /usr/local/bin/google-chrome-cft --version || true

      - name: Increase /dev/shm size for Chrome
        run: |
          sudo mount -o remount,size=2g /dev/shm
          df -h /dev/shm

      - name: Start Xvfb virtual display
        run: |
          sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 &
          echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: Run Tests
        id: run-tests
        env:
          DISPLAY: :99
        run: |
          mvn test \
            -Dheadless=true \
            -Dwebdriver.chrome.driver=/usr/local/bin/chromedriver \
            -Dwebdriver.chrome.binary=/usr/local/bin/google-chrome-cft \
            -Djunit.jupiter.execution.parallel.enabled=false

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports/
          retention-days: 7

      - name: Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: |
            test-output/
            screenshots/
          retention-days: 7

      - name: Notify Slack on success
        if: success()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "*Newsletter Selenium Tests — PASSED*",
              "attachments": [
                {
                  "color": "#36a64f",
                  "fields": [
                    { "title": "Repository",   "value": "${{ github.repository }}", "short": true },
                    { "title": "Branch",       "value": "${{ github.ref_name }}",   "short": true },
                    { "title": "Triggered by", "value": "${{ github.actor }}",      "short": true },
                    { "title": "Run",          "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run #${{ github.run_number }}>", "short": true }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Notify Slack on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "*Newsletter Selenium Tests — FAILED*",
              "attachments": [
                {
                  "color": "#e01e5a",
                  "fields": [
                    { "title": "Repository",   "value": "${{ github.repository }}", "short": true },
                    { "title": "Branch",       "value": "${{ github.ref_name }}",   "short": true },
                    { "title": "Triggered by", "value": "${{ github.actor }}",      "short": true },
                    { "title": "Run",          "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run #${{ github.run_number }}>", "short": true }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

#      - name: Fail build on test failures
#        if: steps.run-tests.outcome == 'failure'
#        run: exit 1