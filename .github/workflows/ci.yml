name: Newsletter Automation CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Install Chrome and ChromeDriver (chrome-for-testing)
        run: |
          STABLE_VERSION=$(curl -s https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions.json \
            | python3 -c "import sys,json; print(json.load(sys.stdin)['channels']['Stable']['version'])")
          echo "Installing Chrome for Testing: $STABLE_VERSION"

          BASE_URL="https://storage.googleapis.com/chrome-for-testing-public/${STABLE_VERSION}/linux64"

          wget -q "${BASE_URL}/chrome-linux64.zip" -O chrome.zip
          wget -q "${BASE_URL}/chromedriver-linux64.zip" -O chromedriver.zip

          unzip -q chrome.zip
          unzip -q chromedriver.zip

          sudo mv chrome-linux64/chrome /usr/local/bin/google-chrome-cft
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
          sudo chmod +x /usr/local/bin/google-chrome-cft /usr/local/bin/chromedriver

          sudo cp -r chrome-linux64/* /usr/local/bin/ 2>/dev/null || true

          chromedriver --version
          /usr/local/bin/google-chrome-cft --version || true

      - name: Increase /dev/shm size for Chrome
        run: |
          sudo mount -o remount,size=2g /dev/shm
          df -h /dev/shm

      - name: Start Xvfb virtual display
        run: |
          sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 &
          echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: Run Tests
        id: run-tests
        env:
          DISPLAY: :99
        run: |
          mvn test \
            -Dheadless=true \
            -Dwebdriver.chrome.driver=/usr/local/bin/chromedriver \
            -Dwebdriver.chrome.binary=/usr/local/bin/google-chrome-cft \
            -Djunit.jupiter.execution.parallel.enabled=false

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports/
          retention-days: 7

      - name: Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: |
            test-output/
            screenshots/
          retention-days: 7

      - name: Parse Test Results
        if: always()
        id: test-results
        run: |
          TESTS=$(grep -h 'tests="' target/surefire-reports/*.xml | grep -oP 'tests="\K[0-9]+' | awk '{s+=$1} END {print s}')
          FAILURES=$(grep -h 'failures="' target/surefire-reports/*.xml | grep -oP 'failures="\K[0-9]+' | awk '{s+=$1} END {print s}')
          ERRORS=$(grep -h 'errors="' target/surefire-reports/*.xml | grep -oP 'errors="\K[0-9]+' | awk '{s+=$1} END {print s}')
          SKIPPED=$(grep -h 'skipped="' target/surefire-reports/*.xml | grep -oP 'skipped="\K[0-9]+' | awk '{s+=$1} END {print s}')
          PASSED=$((TESTS - FAILURES - ERRORS - SKIPPED))

          echo "total=$TESTS" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILURES" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT

          PASS_LIST=$(python3 -c "
          import xml.etree.ElementTree as ET, glob
          results = []
          for f in sorted(glob.glob('target/surefire-reports/*.xml')):
              tree = ET.parse(f)
              for tc in tree.findall('testcase'):
                  if tc.find('failure') is None and tc.find('error') is None:
                      results.append('‚úÖ ' + tc.get('name'))
          print('\n'.join(results))
          " | tr '\n' '|' | sed 's/|/\\n/g' | sed 's/\\n$//')

          FAIL_LIST=$(python3 -c "
          import xml.etree.ElementTree as ET, glob
          results = []
          for f in sorted(glob.glob('target/surefire-reports/*.xml')):
              tree = ET.parse(f)
              for tc in tree.findall('testcase'):
                  if tc.find('failure') is not None or tc.find('error') is not None:
                      results.append('‚ùå ' + tc.get('name'))
          print('\n'.join(results))
          " | tr '\n' '|' | sed 's/|/\\n/g' | sed 's/\\n$//')

          echo "pass_list=$PASS_LIST" >> $GITHUB_OUTPUT
          echo "fail_list=$FAIL_LIST" >> $GITHUB_OUTPUT

      - name: Notify Slack on success
        if: success()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "*Newsletter Selenium Tests ‚Äî PASSED ‚úÖ*",
              "attachments": [
                {
                  "color": "#36a64f",
                  "fields": [
                    { "title": "Repository",   "value": "${{ github.repository }}", "short": true },
                    { "title": "Branch",       "value": "${{ github.ref_name }}",   "short": true },
                    { "title": "Triggered by", "value": "${{ github.actor }}",      "short": true },
                    { "title": "Run",          "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run #${{ github.run_number }}>", "short": true },
                    { "title": "Results",      "value": "‚úÖ ${{ steps.test-results.outputs.passed }} Passed  ‚ùå ${{ steps.test-results.outputs.failed }} Failed  ‚è≠Ô∏è ${{ steps.test-results.outputs.skipped }} Skipped  üìã ${{ steps.test-results.outputs.total }} Total", "short": false },
                    { "title": "Passed Tests", "value": "${{ steps.test-results.outputs.pass_list }}", "short": false }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Notify Slack on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "*Newsletter Selenium Tests ‚Äî FAILED ‚ùå*",
              "attachments": [
                {
                  "color": "#e01e5a",
                  "fields": [
                    { "title": "Repository",   "value": "${{ github.repository }}", "short": true },
                    { "title": "Branch",       "value": "${{ github.ref_name }}",   "short": true },
                    { "title": "Triggered by", "value": "${{ github.actor }}",      "short": true },
                    { "title": "Run",          "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run #${{ github.run_number }}>", "short": true },
                    { "title": "Results",      "value": "‚úÖ ${{ steps.test-results.outputs.passed }} Passed  ‚ùå ${{ steps.test-results.outputs.failed }} Failed  ‚è≠Ô∏è ${{ steps.test-results.outputs.skipped }} Skipped  üìã ${{ steps.test-results.outputs.total }} Total", "short": false },
                    { "title": "Passed Tests", "value": "${{ steps.test-results.outputs.pass_list }}", "short": false },
                    { "title": "Failed Tests", "value": "${{ steps.test-results.outputs.fail_list }}", "short": false }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Fail build on test failures
        if: steps.run-tests.outcome == 'failure'
        run: exit 1